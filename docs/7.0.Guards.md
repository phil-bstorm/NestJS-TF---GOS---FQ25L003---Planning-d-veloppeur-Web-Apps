# Guard

Les guards en NestJS sont utilisés pour protéger les routes et contrôler l'accès aux ressources. Ils permettent de
vérifier si une requête est autorisée à accéder à un endpoint spécifique.

## Connected Guard

Le `ConnectedGuard` est un guard personnalisé qui vérifie si l'utilisateur est connecté avant de lui permettre d'accéder
à certaines routes.

Il est utilisé pour protéger les routes qui nécessitent une authentification.

### Création du Connected Guard

Création du `ConnectedGuard` :

```bash
nest g guard guards/connected
```

```typescript
import { CanActivate, ExecutionContext, Injectable } from '@nestjs/common';
import { Request } from 'express';
import { Observable } from 'rxjs';
import { Session } from 'src/shared/interfaces/session.interface';

@Injectable()
export class ConnectedGuard implements CanActivate {
  canActivate(context: ExecutionContext): boolean | Promise<boolean> | Observable<boolean> {
    const request: Request & { session: Session } = context.switchToHttp().getRequest();
    const session = request.session;

    if (!session) {
      // Si l'utilisateur n'est pas connecté (pas de session), on refuse l'accès
      return false;
    }

    return true;
  }
}
```

explication:

- `CanActivate`: Interface qui définit la méthode `canActivate` pour les guards.
- `ExecutionContext`: Permet d'accéder au contexte d'exécution de la requête.
- `Request`: Type de la requête HTTP, étendu pour inclure la session.
- `Session`: Interface personnalisée pour représenter la session de l'utilisateur.
- Contenu: Méthode qui vérifie si l'utilisateur est connecté en vérifiant la présence de la session. Si la session n'est
  pas présente, l'accès est refusé.

### Utilisation du Connected Guard

Pour utiliser le `ConnectedGuard`, il faut l'ajouter `@UseGuards(ConnectedGuard)` au dessus des routes ou des
contrôleurs ou des modules que vous souhaitez protéger.

Exemple d'utilisation dans un contrôleur :

```typescript
  @Get(':id')
  @UseGuards(ConnectedGuard) // Protège cette route avec le ConnectedGuard
  async getById(@Param('id', ParseIntPipe) id: number) {
    const entity = await this.todoService.getById(id);
    return todoEntityToTodoDto(entity);
  }
```
