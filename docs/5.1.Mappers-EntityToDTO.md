# Mappers

‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è

Attention, les DTOs ne sont suppos√©s √™tre utilis√©s que pour le transfert de
donn√©es (cad dans les controlleurs) et ne doivent pas √™tre utilis√©s pour la logique m√©tier. Pour cela, nous utiliserons
des entit√©s (Entities) qui seront utilis√©es dans les services.

Pour faire le passage entre les DTOs et les entit√©s, nous cr√©erons des mappers (des classes qui convertissent un DTO
en une entit√© et vice versa). Ces mappers seront utilis√©s dans les controleurs.

‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è

## Les mappers Todo

Cr√©ons un dossier `mappers` dans `src`, puis un fichier `todo.mappers.ts` √† l'int√©rieur. Ce fichier contiendra les mappers pour l'entit√© `Todo`.

```typescript
import { Todo } from '../entities/todo.entity';
import { TodoFormDto, TodoUpdateDto, TodoCompletionDto } from '../dtos/todo.form.dto';
import { TodoDto } from '../dtos/todo.dto';

// DTO -> Entit√©
export function todoFormDtoToEntity(dto: TodoFormDto): Todo {
  const todo = new Todo();
  todo.title = dto.title;
  todo.description = dto.description ?? null;
  todo.completed = dto.completed ?? false;
  return todo;
}

export function todoUpdateDtoToEntity(dto: TodoUpdateDto, existing: Todo): Todo {
  if (dto.title !== undefined) {
    existing.title = dto.title;
  }
  if (dto.description !== undefined) {
    existing.description = dto.description;
  }
  return existing;
}

export function todoCompletionDtoToEntity(dto: TodoCompletionDto, existing: Todo): Todo {
  if (dto?.completed !== undefined) {
    existing.completed = dto.completed;
  }
  return existing;
}

// Entit√© -> DTO
export function todoEntityToDto(todo: Todo): TodoDto {
  return {
    id: todo.id,
    title: todo.title,
    description: todo.description,
    completed: todo.completed,
  };
}
```

explications:

- `todoFormDtoToEntity`: Convertit un `TodoFormDto` en une entit√© `Todo` pour la cr√©ation.
- `todoUpdateDtoToEntity`: Met √† jour une entit√© `Todo` existante avec les donn√©es d'un `TodoUpdateDto`.
- `todoCompletionDtoToEntity`: Met √† jour l'√©tat de compl√©tion d'une entit√© `Todo` avec les donn√©es d'un `TodoCompletionDto`.
- `todoEntityToDto`: Convertit une entit√© `Todo` en un `TodoDto` pour la r√©ponse API.

## Utilisation des mappers dans le controleur et utilisation des entit√©s dans le service

üîé Rechercher apr√®s tout les `// NEW` dans le code du controleur pour voir les endroits o√π nous avons utilis√© les mappers.

```typescript
import {
  Body,
  Controller,
  Delete,
  Get,
  Param,
  ParseIntPipe,
  Patch,
  Post,
  Put,
} from '@nestjs/common';
import { ApiTags, ApiOperation, ApiParam, ApiBody, ApiResponse } from '@nestjs/swagger';
import { TodoService } from '../services/todo.service';
import { TodoCompletionDto, TodoFormDto, TodoUpdateDto } from '../dtos/todo.form.dto';
import { TodoDto } from '../dtos/todo.dto';
import {
  todoCompletionDtoToEntity,
  todoEntityToDto,
  todoFormDtoToEntity,
  todoUpdateDtoToEntity,
} from '../mappers/todo.mappers';

@ApiTags('todo')
@Controller('todo')
export class TodoController {
  constructor(private readonly todoService: TodoService) {}

  @Get()
  async getTodos(): Promise<TodoDto[]> {
    const todos = await this.todoService.getTodos();
    return todos.map(todoEntityToDto); // NEW convertit chaque entit√© Todo en DTO
  }

  @Post()
  async createTodo(@Body() body: TodoFormDto): Promise<TodoDto> {
    const todoEntity = todoFormDtoToEntity(body); // NEW Convertit le DTO en entit√©
    const created = await this.todoService.createTodo(todoEntity);
    return todoEntityToDto(created);
  }

  @Get(':id')
  async getTodoById(@Param('id', ParseIntPipe) id: number): Promise<TodoDto> {
    const todo = await this.todoService.getTodoById(id);
    return todoEntityToDto(todo); // NEW Convertit l'entit√© Todo en DTO
  }

  @Put(':id')
  async updateTodo(
    @Param('id', ParseIntPipe) id: number,
    @Body() body: TodoUpdateDto,
  ): Promise<TodoDto> {
    const todo = await this.todoService.getTodoById(id);
    const updatedEntity = todoUpdateDtoToEntity(body, todo); // NEW Convertit le DTO en entit√©
    const updated = await this.todoService.updateTodo(id, updatedEntity);
    return todoEntityToDto(updated);
  }

  @Patch(':id/complete')
  async toggleTodoCompletion(
    @Param('id', ParseIntPipe) id: number,
    @Body() body: TodoCompletionDto,
  ): Promise<TodoDto> {
    const todo = await this.todoService.getTodoById(id);
    const patchedEntity = todoCompletionDtoToEntity(body, todo); // NEW Convertit le DTO en entit√©
    const updated = await this.todoService.updateTodo(id, patchedEntity);
    return todoEntityToDto(updated);
  }

  @Delete(':id')
  async deleteTodo(@Param('id', ParseIntPipe) id: number): Promise<TodoDto> {
    const deleted = await this.todoService.deleteTodo(id);
    return todoEntityToDto(deleted); // NEW Convertit l'entit√© Todo supprim√©e en DTO
  }
}
```

Dans le service, nous allons utiliser uniquement les **entit√©s**, pas les DTOs. Voici un exemple de service `TodoService` :

```typescript
import { Injectable, NotFoundException } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { Todo } from '../entities/todo.entity';

@Injectable()
export class TodoService {
  constructor(
    @InjectRepository(Todo)
    private readonly todoRepository: Repository<Todo>,
  ) {}

  async getTodos(): Promise<Todo[]> {
    return this.todoRepository.find();
  }

  async createTodo(todo: Todo): Promise<Todo> {
    return this.todoRepository.save(todo);
  }

  async getTodoById(id: number): Promise<Todo> {
    const todo = await this.todoRepository.findOne({ where: { id } });
    if (!todo) {
      throw new NotFoundException('Todo not found');
    }
    return todo;
  }

  async updateTodo(id: number, partial: Partial<Todo>): Promise<Todo> {
    const todo = await this.getTodoById(id);
    Object.assign(todo, partial); // Remplir avec les nouvelles valeurs
    return this.todoRepository.save(todo);
  }

  async deleteTodo(id: number): Promise<Todo> {
    const todo = await this.getTodoById(id);
    await this.todoRepository.remove(todo);
    return todo;
  }
}
```
