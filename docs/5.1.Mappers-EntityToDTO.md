# Mappers

## DTO to Entity

Les DTO (Data Transfer Object) sont utilis√©s pour d√©finir la structure des donn√©es qui seront envoy√©es ou re√ßues par les
contr√¥leurs. Une fois l'√©tape de validation termin√©e par le contr√¥leur, **les DTOs sont transform√©s en entit√©s** par des `Mappers`

Il faut donc maintenant √©crire des `Mappers` pour transfomer les `DTOs form` en entit√©s et les entit√©s en `DTOs` qui sont retourn√© par l'API.

(voir chapitre Mappers-EntityToDTO)

‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è

Attention, les DTOs ne sont suppos√©s √™tre utilis√©s que pour le transfert de
donn√©es (cad dans les controlleurs) et ne doivent pas √™tre utilis√©s pour la logique m√©tier. Pour cela, nous utiliserons
des entit√©s (Entities) qui seront utilis√©es dans les services.

Pour faire le passage entre les DTOs et les entit√©s, nous cr√©erons des mappers (des classes qui convertissent un DTO
en une entit√© et vice versa). Ces mappers seront utilis√©s dans les controleurs.

‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è

## Les mappers Todo

Cr√©ons un dossier `mappers` dans `src`, puis un fichier `todo.mapper.ts` √† l'int√©rieur. Ce fichier contiendra les mappers pour l'entit√© `Todo`.

```typescript
import { TodoEntity } from '../entities/todo.entity';
import { TodoCreateFormDto, TodoUpdateFormDto, TodoCompletionDto } from '../dtos/todo.form.dto';
import { TodoDto } from '../dtos/todo.dto';

// DTO -> Entit√©
export function todoCreateFormDtoToEntity(dto: TodoCreateFormDto): TodoEntity {
  const todo = new TodoEntity();
  todo.title = dto.title;
  todo.description = dto.description ?? null;
  todo.completed = dto.completed ?? false;
  return todo;
}

export function todoUpdateFormDtoToEntity(
  dto: TodoUpdateFormDto,
  existing: TodoEntity,
): TodoEntity {
  if (dto.title !== undefined) {
    existing.title = dto.title;
  }
  if (dto.description !== undefined) {
    existing.description = dto.description;
  }
  return existing;
}

export function todoCompletionDtoToEntity(
  dto: TodoCompletionDto,
  existing: TodoEntity,
): TodoEntity {
  if (dto?.completed !== undefined) {
    existing.completed = dto.completed;
  }
  return existing;
}

// Entit√© -> DTO
export function todoEntityToDto(todo: TodoEntity): TodoDto {
  return {
    id: todo.id,
    title: todo.title,
    description: todo.description,
    completed: todo.completed,
  };
}
```

explications:

- `todoFormDtoToEntity`: Convertit un `TodoFormDto` en une entit√© `Todo` pour la cr√©ation.
- `todoUpdateDtoToEntity`: Met √† jour une entit√© `Todo` existante avec les donn√©es d'un `TodoUpdateDto`.
- `todoCompletionDtoToEntity`: Met √† jour l'√©tat de compl√©tion d'une entit√© `Todo` avec les donn√©es d'un `TodoCompletionDto`.
- `todoEntityToDto`: Convertit une entit√© `Todo` en un `TodoDto` pour la r√©ponse API.

## Utilisation des mappers dans le controleur pour faire les transformations (Entity <-> DTO)

üîé Rechercher apr√®s tout les `// NEW` dans le code du controleur pour voir les endroits o√π nous avons utilis√© les mappers.

```typescript
import {
  Body,
  Controller,
  Delete,
  Get,
  Param,
  ParseIntPipe,
  Patch,
  Post,
  Put,
} from '@nestjs/common';
import { ApiTags, ApiOperation, ApiParam, ApiBody, ApiResponse } from '@nestjs/swagger';
import { TodoService } from '../services/todo.service';
import { TodoCompletionDto, TodoCreateFormDto, TodoUpdateFormDto } from '../dtos/todo.form.dto';
import { TodoDtoEntity } from '../dtos/todo.dto';
import {
  todoEntityToDto,
  todoCompletionDtoToEntity,
  todoCreateFormDtoToEntity,
  todoUpdateFormDtoToEntity,
} from '../mappers/todo.mappers';

@ApiTags('todo')
@Controller('todo')
export class TodoController {
  constructor(private readonly todoService: TodoService) {}

  @Get()
  async getAll(): Promise<TodoDto[]> {
    const todos = await this.todoService.getAll();
    return todos.map(todoEntityToDto); // NEW convertit chaque entit√© Todo en DTO
  }

  @Post()
  async create(@Body() body: TodoCreateFormDto) {
    const todoEntity = todoCreateFormDtoToEntity(body); // NEW Convertit le DTO en entit√©
    const created = await this.todoService.create(todoEntity);
    return todoEntityToDto(created);
  }

  @Get(':id')
  async getById(@Param('id', ParseIntPipe) id: number) {
    const todo = await this.todoService.getById(id);
    return todoEntityToDto(todo); // NEW Convertit l'entit√© Todo en DTO
  }

  @Put(':id')
  async update(@Param('id', ParseIntPipe) id: number, @Body() body: TodoUpdateFormDto) {
    const todo = await this.todoService.getById(id);
    const updatedEntity = todoUpdateFormDtoToEntity(body, todo); // NEW Convertit le DTO en entit√©
    const updated = await this.todoService.update(id, updatedEntity);
    return todoEntityToDto(updated);
  }

  @Patch(':id/complete')
  async toggleTodoCompletion(
    @Param('id', ParseIntPipe) id: number,
    @Body() body: TodoCompletionDto,
  ) {
    const todo = await this.todoService.getById(id);
    const patchedEntity = todoCompletionDtoToEntity(body, todo); // NEW Convertit le DTO en entit√©
    const updated = await this.todoService.update(id, patchedEntity);
    return todoEntityToDto(updated);
  }

  @Delete(':id')
  async delete(@Param('id', ParseIntPipe) id: number) {
    const deleted = await this.todoService.delete(id);
    return todoEntityToDto(deleted); // NEW Convertit l'entit√© Todo supprim√©e en DTO
  }
}
```
