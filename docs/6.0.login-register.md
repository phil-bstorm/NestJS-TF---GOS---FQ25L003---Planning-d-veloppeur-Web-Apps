# Login et register

Avant de continuer, vers les middlewares, il faut créer un contrôleur pour gérer les actions de connexion et
d'inscription des utilisateurs.

- Installer le package `bcrypt` pour le hachage des mots de passe :

```bash
npm install bcrypt
npm i @types/bcrypt -D
```

- Créer le `auth.service.ts` dans le dossier `src/services` :

```bash
nest g s services/auth
```

```typescript
import { Injectable } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { User } from '../entities/user.entity';
import { Repository } from 'typeorm';
import * as bcrypt from 'bcrypt';

@Injectable()
export class AuthService {
  constructor(
    @InjectRepository(User)
    private readonly userRepository: Repository<User>,
  ) {}

  async register(user: User): Promise<User> {
    // Check if the user already exists
    const existingUser = await this.userRepository.findOne({
      where: { username: user.username },
    });

    if (existingUser) {
      throw new Error('User already exists');
    }

    return this.userRepository.save({
      ...user,
      password: await bcrypt.hash(user.password, 10), // Hash the password before saving
    });
  }

  async login(username: string, password: string): Promise<User> {
    const foundUser = await this.userRepository.findOne({
      where: { username: username },
    });

    if (!foundUser) {
      throw new Error('User not found');
    }

    const isPasswordValid = await bcrypt.compare(password, foundUser.password);
    if (!isPasswordValid) {
      throw new Error('Invalid password');
    }

    return foundUser; // Return the user if login is successful
  }
}
```

- Créer le `auth.form.dto.ts` dans le dossier `src/dtos` :

```typescript
import { IsString } from 'class-validator';

export class RegisterFormDto {
  @IsString()
  username: string;

  @IsString()
  password: string;
}

export class LoginFormDto {
  @IsString()
  username: string;

  @IsString()
  password: string;
}
```

- Créer le `auth.controller.ts` dans le dossier `src/controllers` :

```bash
nest g co controllers/auth
```

```typescript
import { Body, Controller, Post } from '@nestjs/common';
import { ApiOperation, ApiResponse, ApiTags } from '@nestjs/swagger';
import { AuthService } from '../services/auth.service';
import { RegisterFormDto } from '../dtos/auth.form.dto';
import { registerFormDtoToEntity } from '../mappers/auth.mappers';

@Controller('auth')
export class AuthController {
  constructor(private readonly authService: AuthService) {}

  @Post('register')
  async register(@Body() body: RegisterFormDto): Promise<void> {
    const userEntity = registerFormDtoToEntity(body);
    await this.authService.register(userEntity);
    // No return value, just a success response
    return;
  }

  @Post('login')
  async login(@Body() body: { username: string; password: string }): Promise<{ token: string }> {
    const user = await this.authService.login(body.username, body.password);

    // TODO - implémenter la logique de génération de token JWT
    return { token: 'TODO un token!' + user.username };
  }
}
```

## Génération du token JWT

### Dépendances

Pour générer un token JWT lors de la connexion, nous allons utiliser le package `@nestjs/jwt`.

- Installer le package `@nestjs/jwt` et `@nestjs/config` :

```bash
npm install @nestjs/jwt @nestjs/config
```

- `@nestjs/jwt` : Fournit des fonctionnalités pour travailler avec JSON Web Tokens (JWT) dans NestJS.
- `@nestjs/config` : Permet de gérer la configuration de l'application, y compris les variables d'environnement.

### Configuration de l'environnement

- Créer un fichier `.env.dev` à la racine du projet avec le contenu suivant :

```plaintext
NODE_ENV=development
JWT_SECRET="gB2m7==ptkXoH0BD8(<j'?Yrrom%)yrvNLf9oAw#!g=u_qL|wS"
```

Dans app.module.ts, ajouter les imports de `ConfigModule` et `JwtModule` dans le tableau `imports` :

```typescript
// (...)

@Module({
  imports: [
    ConfigModule.forRoot({ envFilePath: ['.env.dev', '.env'] }),
    JwtModule.register({
      secret: process.env.JWT_SECRET,
      signOptions: { expiresIn: '1d' },
    }),
//(...)
```

- `ConfigModule.forRoot()` : Charge les variables d'environnement à partir des fichiers `.env`.
- `JwtModule.register()` : Configure le module JWT avec le secret et les options de signature. Le secret est récupéré à
  partir des variables d'environnement, et le token expirera après 1 jour (`expiresIn: '1d'`).

### Génération du token JWT dans le controller

Dans le `auth.controller.ts`, nous allons injecter le `JwtService` et l'utiliser pour générer un token lors de la
connexion de l'utilisateur.

```typescript
    @Post('login')
    async login(@Body() body: LoginFormDto): Promise<LoginResultDto> {
      const user = await this.authService.login(body.username, body.password);

      return new LoginResultDto(
              await this.jwtService.signAsync({
                id: user.id,
                username: user.username,
              }),
              user,
      );
    }
```
