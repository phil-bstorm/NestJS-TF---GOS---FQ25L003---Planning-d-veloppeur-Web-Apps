# Services
    
Les services dans NestJS sont des classes qui encapsulent la logique métier et sont généralement utilisées pour interagir avec les bases de données, les API externes, ou pour effectuer des opérations complexes. Ils sont souvent injectés dans les contrôleurs ou d'autres services via l'injection de dépendances.

## Création d'un service
Pour créer un service, vous pouvez utiliser la commande CLI de NestJS :

```bash
nest generate service services/nom-du-service
```
ou 
```bash
nest g s services/nom-du-service
```

Ce commande va créer un fichier `nom-du-service.service.ts` dans le dossier `services`.

Note: lorsque l'on crée un service, NestJS ajoute automatiquement le service dans le module parent (ici
`app.module.ts`).

## Exemple de service
Voici un exemple simple d'un service qui gère une liste de tâches :
Toute la logique métier est déplacée du contrôleur vers le service. (ainsi que la liste statique des tâches)

```typescript
import { Injectable } from '@nestjs/common';

@Injectable()
export class TodoService {
  todos = [
    { id: 1, title: 'Learn NestJS', completed: false },
    { id: 2, title: 'Build a REST API', completed: false },
    { id: 3, title: 'Deploy to production', completed: false },
  ];

  async getAll() {
    await new Promise((resolve) => setTimeout(resolve, 1000)); // Simulate async operation
    return this.todos;
  }

  async create(body: any) {
    await new Promise((resolve) => setTimeout(resolve, 1000)); // Simulate async operation

    const newTodo = {
      id: this.todos.length + 1,
      title: body.title,
      completed: false,
    };
    this.todos.push(newTodo);
    return newTodo;
  }

  async getById(id: number) {
    await new Promise((resolve) => setTimeout(resolve, 1000)); // Simulate async operation

    const todo = this.todos.find((todo) => todo.id === id);
    if (!todo) {
      throw new Error('Todo not found');
    }
    return todo;
  }

  async update(id: number, body: any) {
    await new Promise((resolve) => setTimeout(resolve, 1000)); // Simulate async operation

    const existingTodo = this.todos.find((todo) => todo.id === id);
    if (!existingTodo) {
      throw new Error('Todo not found');
    }

    existingTodo.title = body.title || existingTodo.title;

    return existingTodo;
  }

  async delete(id: number) {
    await new Promise((resolve) => setTimeout(resolve, 1000)); // Simulate async operation

    const index = this.todos.findIndex((todo) => todo.id === id);
    if (index === -1) {
      throw new Error('Todo not found');
    }

    const deletedTodo = this.todos.splice(index, 1);
    return deletedTodo[0];
  }

  async toggleTodoCompletion(id: number, body: any) {
    await new Promise((resolve) => setTimeout(resolve, 1000)); // Simulate async operation

    const todo = this.todos.find((todo) => todo.id === id);
    if (!todo) {
      throw new Error('Todo not found');
    }

    todo.completed = body.completed !== undefined ? body.completed : !todo.completed;

    return todo;
  }
}
```

## Mise à jour du contrôleur
Pour utiliser le service dans le contrôleur, vous devez l'injecter via le constructeur du contrôleur. Une fois injecté, vous pouvez appeler les méthodes du service pour récupérer ou manipuler les données.

Voici comment mettre à jour le contrôleur pour utiliser le service `TodoService` :

```typescript
import {
  Body,
  Controller,
  Delete,
  Get,
  Param,
  ParseIntPipe,
  Patch,
  Post,
  Put,
} from '@nestjs/common';
import { TodoService } from '../services/todo.service';

@Controller('todo')
export class TodoController {
  constructor(private readonly todoService: TodoService) {} // Inject the TodoService

  @Get()
  async getAll() {
    return this.todoService.getAll();
  }

  @Post()
  async create(@Body() body: any) {
    return this.todoService.create(body);
  }

  @Get(':id')
  async getById(@Param('id', ParseIntPipe) id: number) {
    return this.todoService.getById(id);
  }

  @Put(':id')
  async update(@Param('id', ParseIntPipe) id: number, @Body() body: any) {
    return this.todoService.update(id, body);
  }

  @Patch(':id/complete')
  async toggleTodoCompletion(@Param('id', ParseIntPipe) id: number, @Body() body: any) {
    return this.todoService.toggleTodoCompletion(id, body);
  }

  @Delete(':id')
  async delete(@Param('id', ParseIntPipe) id: number) {
    return this.todoService.delete(id);
  }
}
```