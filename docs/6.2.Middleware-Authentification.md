# Authentification Middleware

## DÃ©pendances

Un middleware d'authentification peut Ãªtre utilisÃ© pour vÃ©rifier si l'utilisateur est authentifiÃ© avant de lui permettre
d'accÃ©der Ã  certaines routes.

Tout d'abord, assurez-vous d'avoir installÃ© le package `@nestjs/jwt` pour gÃ©rer les tokens JWT :

```bash
npm install @nestjs/jwt
```

## Interface Session

CrÃ©ez une interface pour reprÃ©senter la session de l'utilisateur. Cela peut Ãªtre utile pour typer les donnÃ©es de session
dans votre middleware.

CrÃ©er le fichier `session.interface.ts` dans le dossier `src/interfaces` :

```bash
nest g interface interfaces/session
```

```typescript
import { UserRole } from '../enums/user-role.enum';

export interface Session {
  id: string;
  role: UserRole;
}
```

## CrÃ©ation du Middleware

Voici un exemple de middleware d'authentification :

CrÃ©er le fichier `auth.middleware.ts` dans le dossier `src/middlewares` :

```bash
nest g middleware middlewares/auth
```

```typescript
import { Injectable, NestMiddleware, UnauthorizedException } from '@nestjs/common';
import { JwtService } from '@nestjs/jwt';
import { Request, Response } from 'express';
import { Session } from 'inspector/promises';

@Injectable()
export class AuthMiddleware implements NestMiddleware {
  constructor(private readonly jwtService: JwtService) {}

  use(req: Request & { session: Session }, res: Response, next: () => void) {
    if (!req.headers.authorization) {
      next();
      return;
    }

    // Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9....
    const [type, token] = req.headers.authorization.split(' ');

    if (type.toLowerCase() !== 'bearer') {
      throw new UnauthorizedException('Invalid type');
    }

    try {
      const session = this.jwtService.verify<Session>(token);
      req.session = session;
    } catch {
      throw new UnauthorizedException('Invalid or expired token');
    }

    next();
  }
}
```

Expliquez le code :

- Si l'en-tÃªte `Authorization` n'est pas prÃ©sent, le middleware passe au prochain middleware ou route.
- Extrait le token JWT de l'en-tÃªte `Authorization` en sÃ©parant le type (`Bearer`) et le token avec `split(' ')` (ðŸ”Ž Attention Ã  bien mettre un espace entre les guillements)
- VÃ©rifie que le type est `Bearer`, sinon lance une exception `UnauthorizedException`.
- Utilise le service `JwtService` pour vÃ©rifier et dÃ©coder le token JWT. Si le token est valide, il ajoute les donnÃ©es de session Ã  l'objet `req`.
- Si le token est invalide ou expirÃ©, il lance une exception `UnauthorizedException`.
- Appelle `next()` pour passer au middleware ou Ã  la route suivante.

## Enregistrement du Middleware

Pour enregistrer le middleware, vous devez l'ajouter dans le module principal de votre application (`app.module.ts`) ou
dans un module spÃ©cifique.

```typescript
// (...)
export class AppModule implements NestModule {
  configure(consumer: MiddlewareConsumer) {
    consumer.apply(LoggingMiddleware).forRoutes('*');
    consumer.apply(AuthMiddleware).forRoutes('*'); // NEW
  }
}
```

_ðŸ”Ž sans oubliÃ© l'import de notre `AuthMiddleware`_
