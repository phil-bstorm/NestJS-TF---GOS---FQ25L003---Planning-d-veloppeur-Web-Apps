# Authentification Middleware

## D√©pendances

Un middleware d'authentification peut √™tre utilis√© pour v√©rifier si l'utilisateur est authentifi√© avant de lui permettre
d'acc√©der √† certaines routes.

Tout d'abord, assurez-vous d'avoir install√© le package `@nestjs/jwt` pour g√©rer les tokens JWT :

```bash
npm install @nestjs/jwt
```

## Interface Session

Cr√©ez une interface pour repr√©senter la session de l'utilisateur. Cela peut √™tre utile pour typer les donn√©es de session
dans votre middleware.

Cr√©er le fichier `session.interface.ts` dans le dossier `src/interfaces` :

```bash
nest g interface shared/interfaces/session
```

```typescript
export interface Session {
  id: string;
  role: 'admin' | 'user';
}
```

## Cr√©ation du Middleware

Voici un exemple de middleware d'authentification :

Cr√©er le fichier `auth.middleware.ts` dans le dossier `src/middlewares` :

```bash
nest g middleware middlewares/auth
```

```typescript
import { Injectable, NestMiddleware } from '@nestjs/common';
import { JwtService } from '@nestjs/jwt';
import { NextFunction, Request, Response } from 'express';
import { Session } from '../shared/interfaces/session.interface';

@Injectable()
export class AuthMiddleware implements NestMiddleware {
  constructor(private readonly jwtService: JwtService) {}

  async use(req: Request & { session: Session }, res: Response, next: NextFunction) {
    if (!req.headers.authorization) {
      next();
      return;
    }
    const [type, token] = req.headers.authorization.split(' ');
    if (type !== 'Bearer') {
      next();
      return;
    }
    try {
      req.session = await this.jwtService.verifyAsync<Session>(token);
    } finally {
      next();
    }
  }
}
```

- Le middleware utilise le service `JwtService` (qui provient de `@nestjs/jwt`) de NestJS pour v√©rifier et d√©coder le
  token JWT.
- Le middleware v√©rifie si l'en-t√™te `Authorization` est pr√©sent et s'il contient un token JWT.
- Si le token est valide, il est d√©cod√© et les informations de session sont ajout√©es √† l'objet `req`.
- Si le token n'est pas valide ou absent, la requ√™te continue sans session.
- la session est typ√©e avec l'interface `Session` que nous avons cr√©√©e pr√©c√©demment qui contient les informations de
  l'utilisateur. (tel que l'id et le r√¥le)

## Enregistrement du Middleware

Pour enregistrer le middleware, vous devez l'ajouter dans le module principal de votre application (`app.module.ts`) ou
dans un module sp√©cifique.

```typescript
// (...)
export class AppModule implements NestModule {
  configure(consumer: MiddlewareConsumer) {
    consumer.apply(LoggingMiddleware).forRoutes('*'); // '*' pour tous les routes, ou ['route1', 'route2']
    consumer.apply(AuthMiddleware).forRoutes('*');
  }
}
```

_üîé sans oubli√© l'import du module_
